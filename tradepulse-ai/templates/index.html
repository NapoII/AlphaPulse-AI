{% extends 'base.html' %}
{% block content %}
<div class="text-center mb-3">
  <h2 class="h5 m-0">Daily Market Overview</h2>
  {% if last_updated %}
    <div class="text-muted" style="color:#d7e6f4 !important;">
      <span id="last-updated-ago" data-iso="{{ last_updated }}" title="{{ last_updated }}" aria-label="Last update timestamp">0s</span>
    </div>
  {% endif %}
  <button id="run-btn" class="btn btn-success px-4 mt-2" type="button">Run now</button>
</div>

{% if summary_markdown %}
  <div class="card mb-3">
    <div class="card-body">
      <div id="markdown" class="markdown-body"></div>
    </div>
  </div>
{% else %}
  <div class="alert alert-info" style="background: rgba(33, 62, 99, .35); color:#e8f1fb; border-color: rgba(255,255,255,.12);">No summary yet. Click "Run now" to generate one.</div>
{% endif %}

{% if signals_json and signals_json.signals %}
  <div class="row g-3">
    {% for sig in signals_json.signals %}
      <div class="col-md-4">
        <div class="card signal-card">
          <div class="card-body text-center">
            <h5 class="card-title">{{ sig.name }} ({{ sig.ticker }})</h5>
            {% set url = 'https://finance.yahoo.com/quote/' ~ sig.ticker %}
            {% if sig.action|lower == 'buy' %}
              <a class="btn btn-success" target="_blank" href="{{ url }}">Buy</a>
            {% else %}
              <a class="btn btn-danger" target="_blank" href="{{ url }}">Sell</a>
            {% endif %}
            {% if sig.reason %}
            <p class="mt-3 text-start" style="color:#cfe1f1; font-size:.95rem;">{{ sig.reason }}</p>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="mt-4">
  <h2 class="h5">News today</h2>
  <div class="list-group news-list">
    {% for n in news_items %}
      <a class="list-group-item list-group-item-action" target="_blank" href="{{ n.url }}">
        {% set t = (n.ticker or '').upper() %}
        {% if t %}
          <span class="ticker-badge" onclick="event.stopPropagation(); event.preventDefault(); window.open('https://finance.yahoo.com/quote/'+ '{{ t }}', '_blank')">{{ t }}</span>
        {% endif %}
        {{ n.title }} <small class="text-muted">{{ n.source }}</small>
      </a>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script type="application/json" id="md-json">{{ summary_markdown|tojson }}</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const holder = document.getElementById('md-json');
    if (!holder) return;
    try {
      const md = JSON.parse(holder.textContent || 'null');
      if (md) {
        document.getElementById('markdown').innerHTML = marked.parse(md);
      }
    } catch (e) {
      console.error('Failed to parse markdown JSON:', e);
    }
  });
  </script>
<script>
  // Simple overlay with progress and logs
  (function() {
    const btn = document.getElementById('run-btn');
    if (!btn) return;
    function ensureOverlay() {
      let overlay = document.getElementById('run-overlay');
      if (overlay) return overlay;
      overlay = document.createElement('div');
      overlay.id = 'run-overlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(4, 12, 24, 0.7)';
      overlay.style.backdropFilter = 'blur(4px)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '1050';
      overlay.innerHTML = `
        <div class="card" style="width: 640px; max-width: 92vw; background: rgba(18,28,48,.9); color:#e8f1fb; border:1px solid rgba(255,255,255,.08)">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="m-0">Running analysis…</h5>
              <button type="button" id="run-cancel" class="btn btn-sm btn-outline-light" disabled>Close</button>
            </div>
            <div class="progress mb-2" role="progressbar" aria-label="Progress">
              <div id="run-progress" class="progress-bar" style="width: 2%"></div>
            </div>
            <div id="run-log" style="height: 200px; overflow:auto; background: rgba(0,0,0,.25); padding:.5rem; border-radius:.25rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:.9rem;"></div>
          </div>
        </div>`;
      document.body.appendChild(overlay);
      return overlay;
    }
    function log(line) {
      const box = document.getElementById('run-log');
      if (!box) return;
      const div = document.createElement('div');
      div.textContent = line;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }
    function setPct(p) {
      const bar = document.getElementById('run-progress');
      if (bar) bar.style.width = Math.max(2, Math.min(100, Math.floor(p))) + '%';
    }
    function start() {
      const overlay = ensureOverlay();
      overlay.style.display = 'flex';
      setPct(2);
      log('Starting…');
  const es = new EventSource("{{ url_for('main.run_stream') }}");
      es.addEventListener('progress', (ev) => {
        try {
          const data = JSON.parse(ev.data);
          if (data.pct != null) setPct(data.pct);
          if (data.message) log(data.message);
        } catch (e) { /* ignore */ }
      });
      es.addEventListener('done', () => {
        setPct(100);
        log('Done. Refreshing…');
        es.close();
        setTimeout(() => { window.location.reload(); }, 500);
      });
      es.onerror = () => {
        log('Connection error. You can close this window.');
      };
    }
    btn.addEventListener('click', start);
  })();
</script>
<script>
  (function() {
    const ago = document.getElementById('last-updated-ago');
    if (!ago) return;
    const iso = ago.getAttribute('data-iso');
    const t0 = Date.parse(iso);
    if (!t0) return;
    function fmt(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      if (s < 60) return s + 's';
      const m = Math.floor(s / 60);
      if (m < 60) return m + 'min';
      const h = Math.floor(m / 60);
      if (h < 24) return h + 'h';
      const d = Math.floor(h / 24);
      return d + 'Tage';
    }
    function tick() {
      const now = Date.now();
      ago.textContent = fmt(now - t0);
    }
    tick();
    setInterval(tick, 1000);
  })();
</script>
{% endblock %}
